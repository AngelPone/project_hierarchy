---
title: "mortality_analysis"
author: "Bohan Zhang"
date: "2023-08-21"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
# ts and error representator
source("../R/construct_hierarchy.R", chdir = TRUE)

store_all <- NULL
for (batch in 0:11) {
  store_all <- readRDS(paste0("store_", batch, ".rds"))$output %>%
    output_pre() %>% mutate(batch = batch) %>%
    rowwise() %>%
    mutate(bottom_mean = mean(bottom)) %>%
    ungroup() %>%
    rbind(store_all)
}
```

## Evaluation proceduce

1. calculate the ratio between mae/rmse of reconciled forecasts and mae/rmse of base forecasts
2. mae/rmse of the total, mean, max and min mae/rmse of bottom series
3. summarised over specific domains

## mint and wlsv vs ols and wlss

```{r, include=FALSE}
store_base <- store_all %>% filter(rf_method == "base") %>%
  rename(total_base = total, bottom_base = bottom) %>%
  select(batch, total_base, accuracy_method, bottom_base)

ratio <- store_all %>%
  left_join(store_base, by = c("batch", "accuracy_method")) %>% 
  rowwise() %>%
  mutate(total = total/total_base, bottom = list(c(bottom/bottom_base))) %>%
  mutate(bottom_mean = mean(bottom), bottom_max = max(bottom),  bottom_min = min(bottom)) %>%
  ungroup() %>%
  select(-c(total_base, bottom_base, bottom)) %>%
  filter(rf_method != "base")
```



### OLS and structural scaling are more likely to produce more extreme results.
### robustness: wlsv > mint > wlss > ols

```{r}
ratio %>% group_by(rf_method, accuracy_method) %>% 
  summarise(total= mean(total), bottom_max=mean(bottom_max), 
            bottom_min=mean(bottom_min), bottom_mean=mean(bottom_mean)) %>%
  arrange(accuracy_method)
```

### In general, the improvement of some series comes with the cost of some other series. It's very unlikely that reconciliation improves all the series.


```{r}
ratio %>% filter(bottom_max <= 1.01) %>% select(representator, rf_method, distance, cluster, total, bottom_mean, bottom_max, bottom_min, batch) %>%
  arrange(bottom_max)
```





## K-medoids (only mint, rmse)

```{r}
tmp <- ratio %>% filter(startsWith(cluster, "kmedoids"), rf_method == "mint", accuracy_method == "rmse") %>%
  rowwise() %>% 
  mutate(n_middle = NROW(other$S)) %>%
  select(representator, distance, cluster, total, bottom_mean, bottom_max, bottom_min, n_middle, batch) %>%
  ungroup()
```


### distance

```{r}
tmp %>% group_by(distance) %>% summarise_at(c("total", "bottom_mean", "bottom_max", "bottom_min"), c(mean=function(x){mean(x)}))
```
```{r}
mcb <- function(x) {
  tsutils::nemenyi(x, plottype = "vmcb")
}

## total
tmp %>% select(representator, cluster, batch, distance, total) %>% 
  tidyr::pivot_wider(names_from = "distance", values_from = "total") %>%
  select(-representator, -cluster, -batch) %>%
  mcb()
```

```{r}
tmp %>% select(representator, cluster, batch, distance, bottom_mean) %>% 
  tidyr::pivot_wider(names_from = "distance", values_from = "bottom_mean") %>%
  select(-representator, -cluster, -batch) %>%
  mcb()
```


### representator

```{r}
tmp %>% group_by(representator) %>% summarise_at(c("total", "bottom_mean", "bottom_max", "bottom_min"), c(mean=function(x){mean(x)}))
```

```{r}
tmp %>% select(representator, cluster, batch, distance, total) %>% 
  tidyr::pivot_wider(names_from = "representator", values_from = "total") %>%
  select(-distance, -cluster, -batch) %>%
  mcb()
```

```{r}
# bottom
tmp %>% select(representator, cluster, batch, distance, bottom_mean) %>% 
  tidyr::pivot_wider(names_from = "representator", values_from = "bottom_mean") %>%
  select(-distance, -cluster, -batch) %>%
  mcb()
```
### cluster

```{r}
tmp %>% select(representator, cluster, batch, distance, total) %>% 
  tidyr::pivot_wider(names_from = "cluster", values_from = "total") %>%
  select(-representator, -distance, -batch) %>%
  mcb()
```

```{r}
tmp %>% select(representator, cluster, batch, distance, bottom_mean) %>% 
  tidyr::pivot_wider(names_from = "cluster", values_from = "bottom_mean") %>%
  select(-representator, -distance, -batch) %>%
  mcb()
```

## HCluster

```{r}
tmp <- ratio %>% filter(startsWith(cluster, "hcluster"), rf_method == "mint", accuracy_method == "rmse") %>%
  rowwise() %>% 
  mutate(n_middle = NROW(other$S)) %>%
  select(representator, distance, cluster, total, bottom_mean, bottom_max, bottom_min, n_middle, batch) %>%
  ungroup()
```

### representator

```{r}
tmp %>% group_by(distance) %>% summarise_at(c("total", "bottom_mean", "bottom_max", "bottom_min"), c(mean=function(x){mean(x)}))
```
```{r}
## total
tmp %>% select(representator, cluster, batch, distance, total) %>% 
  tidyr::pivot_wider(names_from = "distance", values_from = "total") %>%
  select(-representator, -cluster, -batch) %>%
  mcb()
```

```{r}
tmp %>% select(representator, cluster, batch, distance, bottom_mean) %>% 
  tidyr::pivot_wider(names_from = "distance", values_from = "bottom_mean") %>%
  select(-representator, -cluster, -batch) %>%
  mcb()
```


### representator

```{r}
tmp %>% group_by(representator) %>% summarise_at(c("total", "bottom_mean", "bottom_max", "bottom_min"), c(mean=function(x){mean(x)}))
```

```{r}
tmp %>% select(representator, cluster, batch, distance, total) %>% 
  tidyr::pivot_wider(names_from = "representator", values_from = "total") %>%
  select(-distance, -cluster, -batch) %>%
  mcb()
```

```{r}
# bottom
tmp %>% select(representator, cluster, batch, distance, bottom_mean) %>% 
  tidyr::pivot_wider(names_from = "representator", values_from = "bottom_mean") %>%
  select(-distance, -cluster, -batch) %>%
  mcb()
```
### cluster

```{r}
tmp %>% group_by(cluster) %>% summarise_at(c("total", "bottom_mean", "bottom_max", "bottom_min"), c(mean=function(x){mean(x)}))
```

```{r}
tmp %>% select(representator, cluster, batch, distance, total) %>% 
  tidyr::pivot_wider(names_from = "cluster", values_from = "total") %>%
  select(-representator, -distance, -batch) %>%
  mcb()
```

```{r}
tmp %>% select(representator, cluster, batch, distance, bottom_mean) %>% 
  tidyr::pivot_wider(names_from = "cluster", values_from = "bottom_mean") %>%
  select(-representator, -distance, -batch) %>%
  mcb()
```


### natural hierarchy, random 

```{r}
tmp <- ratio %>% filter((cluster == "natural") | (startsWith(cluster, "random-average") | (startsWith(cluster, "random-average-natural")))) %>%
  filter(rf_method == "mint", accuracy_method == "mae") %>%
  select(-representator, -distance) %>%
  select(batch, cluster,total, bottom_mean)
```


```{r}
tmp %>% group_by(cluster) %>% summarise_at(c("total", "bottom_mean"), c(mean=function(x){mean(x)})) %>%
  arrange(bottom_mean_mean)
```

```{r}
tmp %>% select(-total) %>%
  tidyr::pivot_wider(names_from = "cluster", values_from = "bottom_mean") %>%
  select(-batch) %>%
  mcb()
```


```{r}
tmp %>% select(-bottom_mean) %>%
  tidyr::pivot_wider(names_from = "cluster", values_from = "total") %>%
  select(-batch) %>%
  mcb()
```




```{r}
saveRDS(ratio, "ratio.rds")
```









